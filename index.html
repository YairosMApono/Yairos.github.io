<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0f2d1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Empire Builder - Einzelspieler Strategie</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           STATE-OF-THE-ART DESIGN SYSTEM
           - Glassmorphism, Tiefe, Mikro-Interaktionen
           - Einheitliche Radien, Spacing, Schatten-Hierarchie
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        :root {
            --radius-xl: 24px;
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --radius-xs: 8px;
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.25);
            --shadow-medium: 0 8px 32px rgba(0,0,0,0.35);
            --shadow-strong: 0 12px 48px rgba(0,0,0,0.45);
            --shadow-glow: 0 0 40px rgba(201,162,39,0.25);
            --shadow-inner: inset 0 2px 8px rgba(0,0,0,0.3);
            --gold: #d4af37;
            --gold-light: #f0e68c;
            --gold-dim: rgba(212,175,55,0.18);
            --parchment: #f5ecd7;
            --parchment-dark: #c9b896;
            --forest: #0f2d1a;
            --forest-light: #1e4d2e;
            --surface: rgba(15,45,26,0.88);
            --surface-elevated: rgba(25,55,35,0.95);
            --surface-glass: rgba(20,45,28,0.75);
            --border: rgba(212,175,55,0.28);
            --border-active: rgba(212,175,55,0.7);
            --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
        body {
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            font-family: 'Crimson Text', serif;
            background: 
                radial-gradient(ellipse 120% 80% at 50% -20%, rgba(30,77,46,0.4) 0%, transparent 50%),
                radial-gradient(ellipse 80% 60% at 80% 100%, rgba(15,45,26,0.6) 0%, transparent 40%),
                linear-gradient(160deg, #061510 0%, #0d2818 25%, #143d22 50%, #0f2d1a 75%, #061510 100%);
            background-attachment: fixed;
            color: var(--parchment);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Card Pattern - Glassmorphism mit Tiefe */
        .card-pattern {
            background: var(--surface-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            box-shadow: var(--shadow-soft), var(--shadow-inner);
            transition: border-color 0.3s var(--ease-out), box-shadow 0.3s var(--ease-out), transform 0.3s var(--ease-out);
        }
        .card-pattern:hover { border-color: var(--border-active); box-shadow: var(--shadow-medium), var(--shadow-glow); }
        .card-pattern.elevated { background: var(--surface-elevated); box-shadow: var(--shadow-medium), var(--shadow-inner); }

        .game-container { max-width: 1400px; margin: 0 auto; padding: var(--space-sm); min-height: 100vh; }

        /* Header - Premium Typografie */
        .game-header {
            text-align: center;
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
        }
        .game-header h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.6rem, 5vw, 2.4rem);
            font-weight: 700;
            letter-spacing: 0.08em;
            color: var(--gold);
            text-shadow: 0 0 32px rgba(212,175,55,0.5), 0 2px 4px rgba(0,0,0,0.4);
            animation: titleGlow 4s ease-in-out infinite alternate;
        }
        @keyframes titleGlow { to { text-shadow: 0 0 40px rgba(212,175,55,0.6), 0 2px 4px rgba(0,0,0,0.4); } }
        .game-header p { font-size: 1rem; opacity: 0.9; margin-top: var(--space-xs); letter-spacing: 0.02em; }

        /* Resource Bar - Glassmorphism */
        .resource-bar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: var(--radius-lg);
            background: var(--surface-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft), var(--shadow-inner);
        }
        .resource {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs) var(--space-sm);
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            min-width: 130px;
            transition: all 0.3s var(--ease-out);
        }
        .resource:hover { border-color: var(--border-active); transform: translateY(-2px); box-shadow: var(--shadow-soft); }
        .resource-icon { font-size: 1.4rem; filter: drop-shadow(0 0 8px rgba(212,175,55,0.5)); }
        .resource-value { font-family: 'Cinzel', serif; font-weight: 700; color: var(--gold-light); font-size: 1.05rem; }
        .resource-rate { font-size: 0.75rem; color: #7cb87c; }
        .resource-storage { font-size: 0.7rem; color: rgba(255,255,255,0.45); }

        /* Tabs - Pill-Form mit Mikro-Interaktion */
        .tabs {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
            flex-wrap: wrap;
        }
        .tab {
            padding: var(--space-sm) var(--space-md);
            background: var(--surface-glass);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--parchment);
            transition: all 0.3s var(--ease-out);
        }
        .tab:hover { border-color: var(--border-active); background: var(--gold-dim); transform: translateY(-1px); }
        .tab:active { transform: translateY(0) scale(0.98); }
        .tab.active {
            background: linear-gradient(135deg, rgba(212,175,55,0.25), rgba(212,175,55,0.08));
            border-color: var(--gold);
            color: var(--gold-light);
            box-shadow: var(--shadow-glow), var(--shadow-inner);
        }

        /* Map - Premium Container */
        .map-container {
            background: var(--surface-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-medium), var(--shadow-inner);
            position: relative;
            overflow: hidden;
        }
        .map-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 30%, rgba(212,175,55,0.06) 0%, transparent 60%);
            pointer-events: none;
        }
        .section-title {
            font-family: 'Cinzel', serif;
            text-align: center;
            margin-bottom: var(--space-md);
            color: var(--gold);
            font-size: 1.1rem;
        }
        .section-subtitle { text-align: center; margin-bottom: var(--space-md); font-size: 0.9rem; opacity: 0.9; }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-xs);
            max-width: 480px;
            margin: 0 auto var(--space-md);
            position: relative;
            z-index: 1;
        }
        .map-tile {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3));
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.35s var(--ease-bounce);
        }
        .map-tile:hover {
            transform: scale(1.08);
            border-color: var(--gold);
            box-shadow: var(--shadow-glow), 0 0 20px rgba(212,175,55,0.2);
        }
        .map-tile:active { transform: scale(1.02); }
        .map-tile.village {
            background: linear-gradient(145deg, rgba(212,175,55,0.25), rgba(212,175,55,0.08));
            border-color: var(--gold);
            box-shadow: var(--shadow-glow), var(--shadow-inner);
        }
        .map-tile.village::after { content: 'üè∞'; font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }
        .map-tile.empty::after { content: 'üå≤'; font-size: 1.1rem; opacity: 0.5; }

        /* Village - Building Slots (Card Pattern) */
        .village-view { display: none; }
        .village-view.active { display: block; }
        .village-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            max-width: 560px;
            margin: 0 auto var(--space-lg);
        }
        .building-slot {
            aspect-ratio: 1;
            background: linear-gradient(145deg, var(--surface-glass), rgba(0,0,0,0.3));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.35s var(--ease-out);
            padding: var(--space-sm);
            min-height: 110px;
            box-shadow: var(--shadow-soft);
        }
        .building-slot:hover {
            border-color: var(--gold);
            box-shadow: var(--shadow-glow), 0 -2px 12px rgba(212,175,55,0.15);
            transform: translateY(-4px);
        }
        .building-slot:active { transform: translateY(-1px); }
        .building-slot.empty {
            background: linear-gradient(145deg, rgba(0,0,0,0.4), rgba(0,0,0,0.25));
            border-style: dashed;
            border-color: rgba(212,175,55,0.25);
        }
        .building-slot .icon { font-size: 2.2rem; margin-bottom: var(--space-xs); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .building-slot .name { font-family: 'Cinzel', serif; font-size: 0.8rem; text-align: center; }
        .building-slot .level { font-size: 0.75rem; color: var(--gold); margin-top: var(--space-xs); }

        /* Resource Fields - Card Pattern */
        .resource-fields {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--space-sm);
            max-width: 420px;
            margin: 0 auto var(--space-lg);
        }
        .field {
            aspect-ratio: 1;
            background: linear-gradient(145deg, var(--surface-glass), rgba(0,0,0,0.25));
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.35s var(--ease-bounce);
            padding: var(--space-xs);
            box-shadow: var(--shadow-soft);
        }
        .field:hover {
            border-color: var(--gold);
            transform: scale(1.08);
            box-shadow: var(--shadow-glow);
        }
        .field:active { transform: scale(1.02); }
        .field .icon { font-size: 1.6rem; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3)); }
        .field .name { font-size: 0.7rem; margin-top: 2px; }
        .field .lvl { font-size: 0.75rem; color: var(--gold); margin-top: 2px; }

        /* Queue - Premium Progress */
        .queue {
            background: var(--surface-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-soft), var(--shadow-inner);
        }
        .queue-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs);
        }
        .queue-item .progress {
            flex: 1;
            height: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: var(--radius-xs);
            overflow: hidden;
            box-shadow: var(--shadow-inner);
        }
        .queue-item .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: var(--radius-xs);
            transition: width 0.2s var(--ease-out);
            box-shadow: 0 0 12px rgba(212,175,55,0.4);
        }

        /* Modal - Premium Overlay */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-md);
        }
        .modal.show { display: flex; animation: modalFadeIn 0.3s var(--ease-out); }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: var(--surface-elevated);
            border: 1px solid var(--gold);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            max-width: 420px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong), 0 0 80px rgba(212,175,55,0.2), var(--shadow-inner);
            animation: modalSlideIn 0.35s var(--ease-bounce);
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-content h2 { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: var(--space-sm); font-size: 1.2rem; }
        .modal-content .costs { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin: var(--space-sm) 0; }
        .modal-content .cost { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; padding: 4px 8px; background: rgba(0,0,0,0.3); border-radius: var(--radius-xs); }
        .modal-content .cost.can { color: #7cb87c; }
        .modal-content .cost.cannot { color: #e07a7a; }
        .modal-content .time { margin: var(--space-xs) 0; color: var(--gold-light); font-size: 0.9rem; }
        .modal-content .desc { font-size: 0.9rem; margin-bottom: var(--space-sm); opacity: 0.9; line-height: 1.4; }
        .modal-actions { display: flex; gap: var(--space-sm); margin-top: var(--space-md); justify-content: flex-end; }

        /* Buttons - Premium mit Mikro-Interaktion */
        .btn {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--gold);
            background: linear-gradient(180deg, var(--gold-dim), rgba(212,175,55,0.08));
            color: var(--gold-light);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.3s var(--ease-out);
            box-shadow: var(--shadow-inner);
        }
        .btn:hover:not(:disabled) { background: rgba(212,175,55,0.35); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: translateY(0) scale(0.98); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; filter: grayscale(0.3); }
        .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: 0.85rem; }
        .btn-danger { border-color: #b85454; color: #e8b0b0; background: linear-gradient(180deg, rgba(184,84,84,0.25), rgba(184,84,84,0.1)); }
        .btn-danger:hover:not(:disabled) { background: rgba(184,84,84,0.35); }

        /* Troops - Premium Cards */
        .troops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: var(--space-md); }
        .troop-card {
            background: linear-gradient(145deg, var(--surface-glass), rgba(0,0,0,0.25));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            transition: all 0.35s var(--ease-out);
            box-shadow: var(--shadow-soft);
        }
        .troop-card:hover { border-color: var(--border-active); transform: translateY(-3px); box-shadow: var(--shadow-glow); }
        .troop-card .icon { font-size: 2.2rem; text-align: center; margin-bottom: var(--space-xs); }
        .troop-card .name { font-family: 'Cinzel', serif; font-size: 0.9rem; margin-bottom: 2px; }
        .troop-card .count { font-size: 1.1rem; color: var(--gold); }
        .troop-card input {
            width: 56px;
            padding: var(--space-xs);
            margin: var(--space-xs) 0;
            text-align: center;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--border);
            border-radius: var(--radius-xs);
            color: var(--parchment);
            font-size: 0.9rem;
        }

        /* Reports - Premium List */
        .report-list { max-height: 380px; overflow-y: auto; }
        .report {
            background: linear-gradient(90deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
            border-left: 4px solid var(--gold);
            transition: background 0.2s;
        }
        .report:hover { background: linear-gradient(90deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)); }
        .report .time { font-size: 0.75rem; color: #7cb87c; margin-bottom: 2px; }

        /* Info Panel - Glassmorphism */
        .info-panel {
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.25));
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-top: var(--space-md);
            border: 1px solid var(--border);
        }
        .info-panel h3 { font-family: 'Cinzel', serif; font-size: 0.95rem; color: var(--gold); margin-bottom: var(--space-xs); }

        /* Help Button - Premium Rund */
        .help-btn {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--gold-dim), rgba(212,175,55,0.08));
            border: 1px solid var(--border);
            color: var(--gold-light);
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            transition: all 0.3s var(--ease-out);
            flex-shrink: 0;
        }
        .help-btn:hover { background: rgba(212,175,55,0.35); border-color: var(--gold); transform: scale(1.1); }
        .section-header { display: flex; align-items: center; justify-content: center; gap: 4px; margin-bottom: var(--space-md); flex-wrap: wrap; }

        /* Help Modal */
        .help-modal .modal-content { max-width: 360px; }
        .help-modal .help-text { font-size: 0.9rem; line-height: 1.5; white-space: pre-line; }

        /* Mobile - Alles im Bildschirm */
        @media (max-width: 600px) {
            .game-container { padding: var(--space-xs); }
            .game-header { padding: var(--space-sm); }
            .game-header h1 { font-size: 1.3rem; }
            .resource-bar { padding: var(--space-sm); gap: var(--space-xs); }
            .resource { min-width: 0; flex: 1 1 70px; padding: var(--space-xs); }
            .resource-value { font-size: 0.95rem; }
            .resource-storage { font-size: 0.65rem; }
            .tabs { gap: 2px; margin-bottom: var(--space-sm); }
            .tab { padding: var(--space-xs) var(--space-sm); font-size: 0.8rem; }
            .map-container { padding: var(--space-sm); border-radius: var(--radius-lg); }
            .section-title { font-size: 1rem; margin-bottom: var(--space-sm); }
            .section-subtitle { font-size: 0.85rem; margin-bottom: var(--space-sm); }
            .map-grid { max-width: 100%; gap: 2px; }
            .map-tile.village::after { font-size: 1.4rem; }
            .map-tile.empty::after { font-size: 1rem; }
            .village-layout { grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); margin-bottom: var(--space-md); }
            .building-slot { min-height: 90px; padding: var(--space-xs); }
            .building-slot .icon { font-size: 1.8rem; }
            .building-slot .name { font-size: 0.7rem; }
            .resource-fields { grid-template-columns: repeat(3, 1fr); gap: var(--space-xs); margin-bottom: var(--space-md); }
            .field .icon { font-size: 1.4rem; }
            .field .name { font-size: 0.65rem; }
            .troops-grid { grid-template-columns: 1fr 1fr; gap: var(--space-sm); }
            .troop-card { padding: var(--space-sm); }
            .troop-card .icon { font-size: 1.8rem; }
            .report-list { max-height: 50vh; }
            .info-panel { padding: var(--space-sm); margin-top: var(--space-sm); }
        }
        @media (max-width: 380px) {
            .resource { flex: 1 1 65px; }
            .tab { font-size: 0.75rem; padding: 6px 8px; }
        }

        /* Scrollbar - Premium Styling */
        .report-list::-webkit-scrollbar, .modal-content::-webkit-scrollbar { width: 8px; }
        .report-list::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        .report-list::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .report-list::-webkit-scrollbar-thumb:hover, .modal-content::-webkit-scrollbar-thumb:hover { background: var(--border-active); }

        /* Focus - Accessibility */
        .tab:focus-visible, .btn:focus-visible, .help-btn:focus-visible, .map-tile:focus-visible, .building-slot:focus-visible, .field:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <h1>‚öîÔ∏è Empire Builder</h1>
            <p>Baue dein Reich ‚Äì Einzelspieler Strategie</p>
            <button class="btn btn-sm" style="margin-top:0.5rem;font-size:0.8rem" onclick="if(confirm('Neues Spiel starten? Fortschritt geht verloren.')){localStorage.removeItem('empire-game');localStorage.removeItem('empire-start');location.reload()}">üîÑ Neues Spiel</button>
        </header>

        <div class="resource-bar">
            <button class="help-btn" style="align-self:center" onclick="showHelp('resources')">?</button>
            <div class="resource"><span class="resource-icon">ü™µ</span><div><span class="resource-value" id="resWood">0</span><div class="resource-rate" id="rateWood">+0/h</div><div class="resource-storage" id="storeWood"></div></div></div>
            <div class="resource"><span class="resource-icon">üß±</span><div><span class="resource-value" id="resClay">0</span><div class="resource-rate" id="rateClay">+0/h</div><div class="resource-storage" id="storeClay"></div></div></div>
            <div class="resource"><span class="resource-icon">‚öôÔ∏è</span><div><span class="resource-value" id="resIron">0</span><div class="resource-rate" id="rateIron">+0/h</div><div class="resource-storage" id="storeIron"></div></div></div>
            <div class="resource"><span class="resource-icon">üåæ</span><div><span class="resource-value" id="resCrop">0</span><div class="resource-rate" id="rateCrop">+0/h</div><div class="resource-storage" id="storeCrop"></div></div></div>
            <div class="resource" style="margin-left:auto;flex-shrink:0"><span class="resource-icon">‚è±Ô∏è</span><div><span class="resource-value" id="gameTime">Tag 1</span></div></div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="map">üó∫Ô∏è Karte</button>
            <button class="tab" data-tab="village">üè∞ Dorf</button>
            <button class="tab" data-tab="troops">‚öîÔ∏è Truppen</button>
            <button class="tab" data-tab="reports">üìú Berichte</button>
        </div>

        <div id="queueContainer" class="queue" style="display:none"><div id="queueList"></div></div>

        <div id="mapTab" class="village-view active">
            <div class="map-container">
                <div class="section-header"><h3 class="section-title">Weltkarte</h3><button class="help-btn" onclick="showHelp('map')">?</button></div>
                <div class="map-grid" id="mapGrid"></div>
                <div class="info-panel">
                    <h3>‚ÑπÔ∏è Hinweis</h3>
                    <p>Klicke auf dein Dorf (üè∞) um es zu verwalten. Baue Rohstofffelder aus, errichte Geb√§ude und rekrutiere Truppen!</p>
                </div>
            </div>
        </div>

        <div id="villageTab" class="village-view">
            <div class="map-container">
                <div class="section-header"><h3 class="section-title">Dorfzentrum</h3><button class="help-btn" onclick="showHelp('village')">?</button></div>
                <p class="section-subtitle">Klicke auf ein Geb√§ude oder Feld zum Ausbauen</p>
                <div class="village-layout" id="villageLayout"></div>
                <div class="section-header"><h3 class="section-title">Rohstofffelder</h3><button class="help-btn" onclick="showHelp('fields')">?</button></div>
                <div class="resource-fields" id="resourceFields"></div>
            </div>
        </div>

        <div id="troopsTab" class="village-view">
            <div class="map-container">
                <div class="section-header"><h3 class="section-title">Kaserne</h3><button class="help-btn" onclick="showHelp('troops')">?</button></div>
                <p class="section-subtitle">Rekrutiere Truppen ‚Äì verbrauchen Getreide pro Stunde</p>
                <div class="troops-grid" id="troopsGrid"></div>
            </div>
        </div>

        <div id="reportsTab" class="village-view">
            <div class="map-container">
                <div class="section-header"><h3 class="section-title">Berichte</h3><button class="help-btn" onclick="showHelp('reports')">?</button></div>
                <div class="report-list" id="reportList"></div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal help-modal" style="z-index:1001">
        <div class="modal-content">
            <h2 id="helpTitle">Hilfe</h2>
            <p class="help-text" id="helpText"></p>
            <div class="modal-actions"><button class="btn" onclick="document.getElementById('helpModal').classList.remove('show')">Schlie√üen</button></div>
        </div>
    </div>
    <div id="buildingModal" class="modal">
        <div class="modal-content">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:0.5rem">
                <h2 id="modalTitle">Geb√§ude</h2>
                <button class="help-btn" id="modalHelpBtn" onclick="showModalHelp()" style="display:none">?</button>
            </div>
            <p class="desc" id="modalDesc"></p>
            <div class="costs" id="modalCosts"></div>
            <div class="time" id="modalTime"></div>
            <div class="modal-actions">
                <button class="btn btn-danger" id="modalCancel">Abbrechen</button>
                <button class="btn" id="modalBuild">Ausbauen</button>
            </div>
        </div>
    </div>

    <script>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           GAMEPLAY BALANCE - Optimierte Formeln
           - Rohstoffe: Unterschiedliche Produktion pro Feldtyp
           - Acker teurer (Bottleneck wie Travian)
           - Geb√§ude-Abh√§ngigkeiten erweitert
           - Bauzeit: Main Building reduziert (5% pro Stufe)
           - Speicher: Warehouse/Granary unterschiedlich
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        const BUILDINGS = {
            main: { name: 'Hauptgeb√§ude', icon: 'üèõÔ∏è', desc: 'Reduziert Bau- und Rekrutierungszeiten um 5% pro Stufe. Ohne Voraussetzungen.', base: { wood: 70, clay: 40, iron: 60, crop: 20 }, time: 8000, help: 'Zentrum des Dorfes. Jede Stufe verk√ºrzt alle Bau- und Rekrutierungszeiten um 5%. Sollte zuerst ausgebaut werden.' },
            barracks: { name: 'Kaserne', icon: '‚öîÔ∏è', desc: 'Rekrutiere Infanterie. +10% Rekrutierungsgeschwindigkeit pro Stufe. Voraussetzung: Hauptgeb√§ude St.1', base: { wood: 175, clay: 160, iron: 80, crop: 80 }, time: 12000, help: 'Trainiert Miliz, Schwertk√§mpfer, Speertr√§ger und Axtk√§mpfer. H√∂here Kaserne = schnellere Rekrutierung.' },
            warehouse: { name: 'Lagerhaus', icon: 'üì¶', desc: 'Speichert Holz, Lehm, Eisen. +2500 pro Stufe. Voraussetzung: Hauptgeb√§ude St.1', base: { wood: 130, clay: 160, iron: 90, crop: 40 }, time: 10000, help: 'Erh√∂ht die maximale Menge an Holz, Lehm und Eisen. Ohne Ausbau kannst du keine gro√üen Bauprojekte starten.' },
            granary: { name: 'Getreidespeicher', icon: 'üåæ', desc: 'Speichert Getreide. +2000 pro Stufe. Voraussetzung: Hauptgeb√§ude St.1', base: { wood: 80, clay: 100, iron: 70, crop: 20 }, time: 8000, help: 'Erh√∂ht die maximale Getreide-Menge. Wichtig f√ºr Truppen-Rekrutierung.' },
            wall: { name: 'Stadtmauer', icon: 'üß±', desc: 'Verteidigungsbonus. Voraussetzung: Hauptgeb√§ude St.3, Versammlungsplatz St.1', base: { wood: 70, clay: 90, iron: 170, crop: 70 }, time: 10000, help: 'Sch√ºtzt dein Dorf. Ben√∂tigt Versammlungsplatz (f√ºr Koordination der Verteidiger).' },
            rally: { name: 'Versammlungsplatz', icon: 'üèïÔ∏è', desc: 'Erm√∂glicht 2. Bau-Queue. Voraussetzung: Hauptgeb√§ude St.1, Kaserne St.1', base: { wood: 110, clay: 160, iron: 90, crop: 70 }, time: 11000, help: 'Mit Versammlungsplatz kannst du 2 Geb√§ude/Felder/Truppen gleichzeitig bauen oder rekrutieren.' },
        };

        const FIELDS = [
            { type: 'wood', name: 'Holzf√§ller', icon: 'ü™µ', base: { wood: 40, clay: 50, iron: 30, crop: 50 }, prodBase: 25, prodFactor: 1.22, help: 'Produziert Holz. Wird f√ºr fast alle Geb√§ude und Truppen ben√∂tigt.' },
            { type: 'clay', name: 'Lehmgrube', icon: 'üß±', base: { wood: 40, clay: 50, iron: 30, crop: 50 }, prodBase: 25, prodFactor: 1.22, help: 'Produziert Lehm. Wichtig f√ºr Lagerhaus, Kaserne und Versammlungsplatz.' },
            { type: 'iron', name: 'Eisenmine', icon: '‚öôÔ∏è', base: { wood: 40, clay: 50, iron: 30, crop: 50 }, prodBase: 25, prodFactor: 1.22, help: 'Produziert Eisen. Stadtmauer und h√∂here Geb√§ude ben√∂tigen viel Eisen.' },
            { type: 'crop', name: 'Acker', icon: 'üåæ', base: { wood: 50, clay: 60, iron: 40, crop: 80 }, prodBase: 20, prodFactor: 1.25, help: 'Produziert Getreide. Teurer auszubauen, aber essentiell ‚Äì Truppen verbrauchen Getreide!' },
        ];

        const BUILD_REQS = {
            barracks: { main: 1 },
            warehouse: { main: 1 },
            granary: { main: 1 },
            wall: { main: 3, rally: 1 },
            rally: { main: 1, barracks: 1 },
        };

        const TROOPS = [
            { id: 'militia', name: 'Miliz', icon: 'üõ°Ô∏è', cost: { wood: 60, clay: 70, iron: 40, crop: 20 }, time: 400, consume: 1 },
            { id: 'sword', name: 'Schwertk√§mpfer', icon: '‚öîÔ∏è', cost: { wood: 60, clay: 70, iron: 40, crop: 20 }, time: 500, consume: 1 },
            { id: 'spear', name: 'Speertr√§ger', icon: 'üî±', cost: { wood: 50, clay: 60, iron: 30, crop: 60 }, time: 450, consume: 1 },
            { id: 'axe', name: 'Axtk√§mpfer', icon: 'ü™ì', cost: { wood: 60, clay: 70, iron: 40, crop: 20 }, time: 600, consume: 2 },
        ];

        const RES_ICONS = { wood: 'ü™µ', clay: 'üß±', iron: '‚öôÔ∏è', crop: 'üåæ' };

        function getCost(base, level) {
            return Object.fromEntries(Object.entries(base).map(([k, v]) => [k, Math.floor(v * Math.pow(1.55, level))]));
        }

        function getBuildTime(baseTime, level) {
            const speedBonus = 1 + (game.buildings.main || 0) * 0.05;
            return Math.floor(baseTime * Math.pow(1.5, level) / speedBonus);
        }

        const HELP_TEXTS = {
            resources: 'Rohstoffe: Holz, Lehm, Eisen, Getreide.\n\nProduktion: Rohstofffelder erzeugen pro Stunde. Die Zahl zeigt +X/h.\n\nSpeicher: Lagerhaus (Holz/Lehm/Eisen) und Getreidespeicher begrenzen die Kapazit√§t.\n\nVerbrauch: Truppen verbrauchen Getreide pro Stunde. Wenn Verbrauch > Produktion, sinkt der Getreide-Vorrat.',
            map: 'Weltkarte: Dein Dorf ist in der Mitte (üè∞). Klicke darauf, um zum Dorf-Tab zu wechseln und Geb√§ude/Felder auszubauen.\n\nDie umliegenden Felder k√∂nnen sp√§ter f√ºr weitere D√∂rfer genutzt werden.',
            village: 'Dorfzentrum: 6 Geb√§ude-Pl√§tze.\n\n‚Ä¢ Hauptgeb√§ude: Reduziert Bauzeiten\n‚Ä¢ Kaserne: Truppen rekrutieren\n‚Ä¢ Lagerhaus: Speicher f√ºr Holz, Lehm, Eisen\n‚Ä¢ Getreidespeicher: Speicher f√ºr Getreide\n‚Ä¢ Stadtmauer: Verteidigung\n‚Ä¢ Versammlungsplatz: 2. Bau-Queue\n\nRohstofffelder: 4√ó Holzf√§ller, 4√ó Lehmgrube, 4√ó Eisenmine, 6√ó Acker. Klicken zum Ausbauen.',
            fields: 'Rohstofffelder produzieren kontinuierlich:\n\n‚Ä¢ Holzf√§ller ‚Üí Holz\n‚Ä¢ Lehmgrube ‚Üí Lehm\n‚Ä¢ Eisenmine ‚Üí Eisen\n‚Ä¢ Acker ‚Üí Getreide\n\nJede Stufe erh√∂ht die Produktion. Acker sind teurer (mehr Getreide-Kosten), da Getreide der limitierende Faktor ist.',
            troops: 'Truppen rekrutieren: Ben√∂tigt Kaserne.\n\nJede Einheit verbraucht Getreide pro Stunde (steht bei jedem Typ). Achte darauf, dass deine Getreide-Produktion den Verbrauch deckt.\n\nHauptgeb√§ude und Kaserne beschleunigen die Rekrutierung.',
            reports: 'Berichte protokollieren alle Aktionen: Bauabschl√ºsse, Rekrutierungen, Warnungen. Die neuesten stehen oben.'
        };
        function showHelp(key) {
            document.getElementById('helpTitle').textContent = 'Hilfe';
            document.getElementById('helpText').textContent = HELP_TEXTS[key] || 'Keine Hilfe verf√ºgbar.';
            document.getElementById('helpModal').classList.add('show');
        }
        let currentModalHelp = '';
        function showModalHelp() {
            if (!currentModalHelp) return;
            document.getElementById('helpTitle').textContent = 'Erkl√§rung';
            document.getElementById('helpText').textContent = currentModalHelp;
            document.getElementById('helpModal').classList.add('show');
        }

        let game = {
            resources: { wood: 0, clay: 0, iron: 0, crop: 0 },
            buildings: { main: 0, barracks: 0, warehouse: 0, granary: 0, wall: 0, rally: 0 },
            fields: [...Array(4).fill('wood'), ...Array(4).fill('clay'), ...Array(4).fill('iron'), ...Array(6).fill('crop')].map(type => ({ type, level: 0 })),
            troops: { militia: 0, sword: 0, spear: 0, axe: 0 },
            queue: [],
            lastTick: Date.now(),
            day: 1,
            reports: []
        };

        function load() {
            const s = localStorage.getItem('empire-game');
            if (s) {
                const d = JSON.parse(s);
                game = { ...game, ...d, resources: { ...game.resources, ...d.resources }, buildings: { ...game.buildings, ...d.buildings }, troops: { ...game.troops, ...d.troops } };
            }
            if (game.fields.length !== 18) game.fields = [...Array(4).fill('wood'), ...Array(4).fill('clay'), ...Array(4).fill('iron'), ...Array(6).fill('crop')].map(type => ({ type, level: 0 }));
            game.resources = { wood: 750, clay: 750, iron: 750, crop: 750, ...game.resources };
            if (game.buildings.main === 0 && game.fields.every(f => f.level === 0)) {
                game.buildings.main = 1;
                game.fields = game.fields.map(f => ({ ...f, level: 1 }));
            }
        }

        function save() {
            localStorage.setItem('empire-game', JSON.stringify({
                resources: game.resources,
                buildings: game.buildings,
                fields: game.fields,
                troops: game.troops,
                queue: game.queue,
                day: game.day,
                reports: game.reports.slice(-80)
            }));
        }

        function production() {
            const prod = { wood: 0, clay: 0, iron: 0, crop: 0 };
            game.fields.forEach(f => {
                if (f.level > 0) {
                    const type = FIELDS.find(x => x.type === f.type);
                    prod[f.type] += Math.floor(type.prodBase * Math.pow(type.prodFactor, f.level - 1));
                }
            });
            return prod;
        }

        function storage() {
            const w = 2000 + (game.buildings.warehouse || 0) * 2500;
            const g = 2000 + (game.buildings.granary || 0) * 2000;
            return { wood: w, clay: w, iron: w, crop: g };
        }

        function consume() {
            return Object.entries(game.troops).reduce((s, [id, c]) => s + (TROOPS.find(t => t.id === id)?.consume || 0) * (c || 0), 0);
        }

        function maxQueueSlots() {
            return (game.buildings.rally || 0) > 0 ? 2 : 1;
        }

        function tick() {
            const now = Date.now();
            const dt = (now - game.lastTick) / 1000;
            game.lastTick = now;

            const prod = production();
            const cons = consume();
            const storageMax = storage();

            game.resources.wood = Math.min(storageMax.wood, game.resources.wood + prod.wood * dt / 3600);
            game.resources.clay = Math.min(storageMax.clay, game.resources.clay + prod.clay * dt / 3600);
            game.resources.iron = Math.min(storageMax.iron, game.resources.iron + prod.iron * dt / 3600);
            game.resources.crop = Math.min(storageMax.crop, Math.max(0, game.resources.crop + (prod.crop - cons) * dt / 3600));

            const slots = maxQueueSlots();
            for (let i = 0; i < Math.min(slots, game.queue.length); i++) {
                const q = game.queue[i];
                if (!q) continue;
                q.remaining -= dt * 1000;
                if (q.remaining <= 0) {
                    game.queue.splice(i, 1);
                    if (q.type === 'building') game.buildings[q.id] = (game.buildings[q.id] || 0) + 1;
                    else if (q.type === 'field') game.fields[q.id].level++;
                    else if (q.type === 'troop') game.troops[q.id] = (game.troops[q.id] || 0) + q.count;
                    addReport(`${q.name} abgeschlossen!`);
                    i--;
                }
            }

            const start = parseInt(localStorage.getItem('empire-start') || now);
            game.day = Math.max(1, Math.floor((now - start) / 90000) + 1);

            updateUI();
        }

        function addReport(text) {
            game.reports.push({ text, time: new Date().toLocaleString('de-DE') });
        }

        function updateUI() {
            const prod = production();
            const cons = consume();
            const store = storage();
            document.getElementById('resWood').textContent = Math.floor(game.resources.wood);
            document.getElementById('resClay').textContent = Math.floor(game.resources.clay);
            document.getElementById('resIron').textContent = Math.floor(game.resources.iron);
            document.getElementById('resCrop').textContent = Math.floor(game.resources.crop);
            document.getElementById('rateWood').textContent = `+${prod.wood}/h`;
            document.getElementById('rateClay').textContent = `+${prod.clay}/h`;
            document.getElementById('rateIron').textContent = `+${prod.iron}/h`;
            document.getElementById('rateCrop').textContent = `${prod.crop - cons >= 0 ? '+' : ''}${prod.crop - cons}/h`;
            document.getElementById('storeWood').textContent = `/${store.wood}`;
            document.getElementById('storeClay').textContent = `/${store.clay}`;
            document.getElementById('storeIron').textContent = `/${store.iron}`;
            document.getElementById('storeCrop').textContent = `/${store.crop}`;
            document.getElementById('gameTime').textContent = `Tag ${game.day}`;

            if (game.queue.length > 0) {
                document.getElementById('queueContainer').style.display = 'block';
                const items = game.queue.slice(0, maxQueueSlots());
                document.getElementById('queueList').innerHTML = items.map((q, i) => {
                    const total = q.total || q.remaining;
                    const pct = Math.max(0, (1 - q.remaining / total) * 100);
                    return `<div class="queue-item"><span>${q.icon || 'üî®'} ${q.name}</span><div class="progress"><div class="progress-fill" style="width:${pct}%"></div></div><span>${Math.ceil(q.remaining/1000)}s</span></div>`;
                }).join('');
            } else document.getElementById('queueContainer').style.display = 'none';

            save();
        }

        function renderMap() {
            const grid = document.getElementById('mapGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 49; i++) {
                const t = document.createElement('div');
                t.className = 'map-tile' + (i === 24 ? ' village' : ' empty');
                t.onclick = () => { if (i === 24) switchTab('village'); };
                grid.appendChild(t);
            }
        }

        function canBuild(id) {
            const reqs = BUILD_REQS[id];
            if (!reqs) return true;
            return Object.entries(reqs).every(([bid, lvl]) => (game.buildings[bid] || 0) >= lvl);
        }

        function openBuildingModal(id) {
            const b = BUILDINGS[id];
            const lvl = game.buildings[id] || 0;
            const cost = getCost(b.base, lvl);
            const time = getBuildTime(b.time, lvl);
            const reqOk = canBuild(id);
            const can = reqOk && Object.entries(cost).every(([k, v]) => game.resources[k] >= v);
            const queueFull = game.queue.length >= maxQueueSlots();

            currentModalHelp = b.help || '';
            const helpBtn = document.getElementById('modalHelpBtn');
            helpBtn.style.display = currentModalHelp ? 'flex' : 'none';

            document.getElementById('modalTitle').textContent = b.name + (lvl ? ` (Stufe ${lvl + 1})` : ' (Stufe 1)');
            document.getElementById('modalDesc').textContent = reqOk ? b.desc : 'Voraussetzungen: ' + (BUILD_REQS[id] ? Object.entries(BUILD_REQS[id]).map(([x,y]) => `${BUILDINGS[x]?.name} St.${y}`).join(', ') : '');
            document.getElementById('modalCosts').innerHTML = Object.entries(cost).map(([k, v]) => {
                const ok = game.resources[k] >= v;
                return `<span class="cost ${ok ? 'can' : 'cannot'}">${RES_ICONS[k] || ''} ${Math.floor(v)}</span>`;
            }).join('');
            document.getElementById('modalTime').textContent = `‚è±Ô∏è Bauzeit: ${Math.ceil(time/1000)} Sekunden`;
            document.getElementById('modalBuild').disabled = !can || queueFull;
            document.getElementById('modalBuild').onclick = () => {
                if (!can || queueFull) return;
                Object.entries(cost).forEach(([k, v]) => game.resources[k] -= v);
                game.queue.push({ type: 'building', id, name: `${b.name} St.${lvl + 1}`, icon: b.icon, remaining: time, total: time });
                document.getElementById('buildingModal').classList.remove('show');
                addReport(`Bau: ${b.name} Stufe ${lvl + 1}`);
            };
            document.getElementById('buildingModal').classList.add('show');
        }

        function openFieldModal(idx) {
            const f = game.fields[idx];
            const type = FIELDS.find(x => x.type === f.type);
            const cost = getCost(type.base, f.level);
            const time = getBuildTime(6000, f.level);
            const can = Object.entries(cost).every(([k, v]) => game.resources[k] >= v);
            const queueFull = game.queue.length >= maxQueueSlots();
            const resNames = { wood: 'Holz', clay: 'Lehm', iron: 'Eisen', crop: 'Getreide' };

            currentModalHelp = type.help || '';
            const helpBtn = document.getElementById('modalHelpBtn');
            helpBtn.style.display = currentModalHelp ? 'flex' : 'none';

            document.getElementById('modalTitle').textContent = `${type.name} (Stufe ${f.level + 1})`;
            document.getElementById('modalDesc').textContent = `Produziert ${resNames[type.type]}. Stufe ${f.level + 1}: +${Math.floor(type.prodBase * Math.pow(type.prodFactor, f.level))}/h`;
            document.getElementById('modalCosts').innerHTML = Object.entries(cost).map(([k, v]) => {
                const ok = game.resources[k] >= v;
                return `<span class="cost ${ok ? 'can' : 'cannot'}">${RES_ICONS[k] || ''} ${Math.floor(v)}</span>`;
            }).join('');
            document.getElementById('modalTime').textContent = `‚è±Ô∏è Bauzeit: ${Math.ceil(time/1000)} Sekunden`;
            document.getElementById('modalBuild').disabled = !can || queueFull;
            document.getElementById('modalBuild').onclick = () => {
                if (!can || queueFull) return;
                Object.entries(cost).forEach(([k, v]) => game.resources[k] -= v);
                game.queue.push({ type: 'field', id: idx, name: `${type.name} St.${f.level + 1}`, icon: type.icon, remaining: time, total: time });
                document.getElementById('buildingModal').classList.remove('show');
                addReport(`Ausbau: ${type.name} Stufe ${f.level + 1}`);
            };
            document.getElementById('buildingModal').classList.add('show');
        }

        function renderVillage() {
            const layout = document.getElementById('villageLayout');
            const slots = ['main', 'barracks', 'warehouse', 'granary', 'wall', 'rally'];
            layout.innerHTML = slots.map(id => {
                const b = BUILDINGS[id];
                const lvl = game.buildings[id] || 0;
                return `<div class="building-slot ${lvl ? '' : 'empty'}" data-id="${id}"><span class="icon">${b.icon}</span><span class="name">${b.name}</span><span class="level">${lvl ? 'Stufe ' + lvl : 'Leer'}</span></div>`;
            }).join('');
            layout.querySelectorAll('.building-slot').forEach(el => el.onclick = () => openBuildingModal(el.dataset.id));

            const fields = document.getElementById('resourceFields');
            fields.innerHTML = game.fields.map((f, i) => {
                const type = FIELDS.find(x => x.type === f.type);
                return `<div class="field" data-id="${i}"><span class="icon">${type.icon}</span><span class="name">${type.name}</span><span class="lvl">St. ${f.level}</span></div>`;
            }).join('');
            fields.querySelectorAll('.field').forEach(el => el.onclick = () => openFieldModal(parseInt(el.dataset.id)));
        }

        function renderTroops() {
            const grid = document.getElementById('troopsGrid');
            const canTrain = game.buildings.barracks > 0;
            const queueFull = game.queue.length >= maxQueueSlots();
            grid.innerHTML = TROOPS.map(t => {
                const count = game.troops[t.id] || 0;
                const can = Object.entries(t.cost).every(([k, v]) => game.resources[k] >= v);
                return `<div class="troop-card"><div class="icon">${t.icon}</div><div class="name">${t.name}</div><div class="count">${count} Einheiten</div><small style="opacity:0.7">${t.consume} Getr./h</small>${canTrain ? `<input type="number" id="train${t.id}" min="1" value="1" max="99"><button class="btn btn-sm" onclick="trainTroop('${t.id}')" ${!can || queueFull ? 'disabled' : ''}>Rekrutieren</button>` : '<p style="font-size:0.85rem;color:#8fbc8f;margin-top:4px">Kaserne bauen</p>'}</div>`;
            }).join('');
        }

        function trainTroop(id) {
            const t = TROOPS.find(x => x.id === id);
            const count = Math.min(99, Math.max(1, parseInt(document.getElementById('train' + id)?.value || 1)));
            const cost = Object.fromEntries(Object.entries(t.cost).map(([k, v]) => [k, v * count]));
            const can = Object.entries(cost).every(([k, v]) => game.resources[k] >= v);
            const queueFull = game.queue.length >= maxQueueSlots();
            if (!can || queueFull) return;
            const cons = consume();
            const prod = production();
            if (prod.crop - cons < t.consume * count && (game.troops[id] || 0) + count > 0) {
                addReport(`Warnung: Nicht genug Getreide-Produktion f√ºr ${count}x ${t.name}!`);
            }
            Object.entries(cost).forEach(([k, v]) => game.resources[k] -= v);
            const time = t.time * count * 1000 / (1 + (game.buildings.main || 0) * 0.05) / (1 + (game.buildings.barracks || 0) * 0.1);
            game.queue.push({ type: 'troop', id, count, name: `${count}x ${t.name}`, icon: t.icon, remaining: time, total: time });
            addReport(`Rekrutierung: ${count}x ${t.name}`);
        }

        function renderReports() {
            const list = document.getElementById('reportList');
            list.innerHTML = game.reports.length ? game.reports.slice().reverse().map(r => `<div class="report"><div class="time">${r.time}</div>${r.text}</div>`).join('') : '<p style="text-align:center;padding:2rem;color:#8fbc8f">Noch keine Berichte</p>';
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
            document.querySelectorAll('.village-view').forEach(v => v.classList.remove('active'));
            document.getElementById(name + 'Tab').classList.add('active');
            if (name === 'village') renderVillage();
            if (name === 'troops') renderTroops();
            if (name === 'reports') renderReports();
        }

        document.getElementById('modalCancel').onclick = () => document.getElementById('buildingModal').classList.remove('show');
        document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

        load();
        if (!localStorage.getItem('empire-start')) localStorage.setItem('empire-start', Date.now());
        renderMap();
        renderVillage();
        renderTroops();
        renderReports();
        setInterval(tick, 100);
    </script>
</body>
</html>
